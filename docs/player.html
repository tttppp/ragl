<html>
    <head>
        <title>RAGL Ladder - Player History</title>
        <link rel="stylesheet" href="ragl.css">
        <script src="js/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                $.getJSON('data/replacements.json', function(replacements) {
                    $.getJSON('data/players.json', function(players) {
                        const urlSearchParams = new URLSearchParams(window.location.search);
                        var playerId = Number(urlSearchParams.get('player'));
                        if (!playerId) {
                            const playerIds = Object.keys(players);
                            playerId = playerIds[Math.floor(playerIds.length * Math.random())];
                        }
                        var name = players[playerId];
                        while (playerId in replacements) {
                            playerId = Number(replacements[playerId]);
                            name = players[playerId] + ' (' + name + ')';
                        }
                        $('#name').text(name)

                        $.getJSON('data/players/p'+playerId+'.json', function(weekData) {
                            const weekInProgress = weekData[0]['d'];
                            weekData.forEach(rowData => {
                                const timestamp = rowData['d'];
                                const date = new Date(timestamp * 1000);
                                const rank = rowData['o'];
                                const percentile = rowData['c'];
                                const rating = rowData['r'];
                                const error = rowData['e'];
                                const played = rowData['p'];
                                const won = rowData['w'];
                                const dateText = (timestamp == weekInProgress ? 'Week in progress' : date.toDateString());
                                $('#week').append($('<tr>')
                                        .append($('<td>').append($('<a>').attr('href', 'index.html?timestamp=' + timestamp).text(dateText)))
                                        .append($('<td>').text(rank))
                                        .append($('<td>').text(percentile))
                                        .append($('<td>').text(rating))
                                        .append($('<td>').text(error))
                                        .append($('<td>').text(played))
                                        .append($('<td>').text(won)));
                            });
                            $('#statistics_highestrank').text(Math.min(...weekData.map(rowData => rowData['o'])));
                            $('#statistics_highestpercentile').text(Math.min(...weekData.map(rowData => rowData['c'])));
                            $('#statistics_highestrating').text(Math.max(...weekData.map(rowData => rowData['r'])));
                        });
                    });
                });
            });
        </script>
    </head>
    <body>
        <div id="content">
            <div id="menu">
                <span><a href="index.html">RAGL Ladder</a></span>
                <span><a href="standings.html">RAGL Standings</a></span>
                <span><a href="forfeits.html">RAGL Forfeits</a></span>
                <span><a href="https://github.com/tttppp/ragl/blob/master/rules.md">RAGL Rules</a></span>
            </div>
            <h1><a href="index.html">RAGL Ladder</a></h1>
            <h2>Performance history for <span id="name"></span>:</h2>
            <table id="statistics">
                <tr><th>Highest Rank</th><td id="statistics_highestrank"></td></tr>
                <tr><th>Highest Percentile</th><td id="statistics_highestpercentile"></td></tr>
                <tr><th>Highest Rating</th><td id="statistics_highestrating"></td></tr>
            </table>
            <br />
            <table id="results">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Rank</th>
                        <th>Percentile</th>
                        <th>Rating</th>
                        <th>Error</th>
                        <th>Played</th>
                        <th>Won</th>
                    </tr>
                </thead>
                <tbody id="week">

                </tbody>
            </table>
        </div>
    </body>
</html>
