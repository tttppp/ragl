<html>
    <head>
        <title>RAGL Ladder</title>
        <link rel="stylesheet" href="ragl.css">
        <script src="js/jquery.min.js"></script>
        <script>
            function displayWeek(timestamp) {
                const date = new Date(timestamp * 1000);
                $.getJSON('data/players.json', function(players) {
                    $('#date').text(date.toDateString());
                    $.getJSON('data/weeks/w'+timestamp+'.json', function(weekData) {
                        weekData.forEach((rowData, rowIndex) => {
                            const playerId = rowData['i'];
                            const name = players[playerId];
                            const rating = rowData['r'];
                            const error = rowData['e'];
                            const played = rowData['p'];
                            const won = rowData['w'];
                            $('#week').append($('<tr>')
                                    .append($('<td>').text(rowIndex + 1))
                                    .append($('<td>').append($('<a>').attr('href', 'player.html?player=' + playerId).text(name)))
                                    .append($('<td>').text(rating))
                                    .append($('<td>').text(error))
                                    .append($('<td>').text(played))
                                    .append($('<td>').text(won)))
                        });
                    });
                });
            }

            $(document).ready(function() {
                $.getJSON('data/timestamps.json', function(timestamps) {
                    const urlSearchParams = new URLSearchParams(window.location.search);
                    var timestamp = Number(urlSearchParams.get('timestamp'));
                    const firstWeek = timestamps[0];
                    const weekInProgress = timestamps[timestamps.length - 1];
                    if (!timestamp) {
                        timestamp = timestamps[timestamps.length - 2];
                    }
                    displayWeek(timestamp);
                    // Populate previous/next links.
                    var previousWeekLink = $('<a>').text("Previous Week");
                    if (timestamp > firstWeek) {
                        previousWeekLink.attr('href', '?timestamp=' + (timestamp - 7 * 24 * 60 * 60));
                    }
                    $('#previous').append(previousWeekLink);
                    var nextWeekLink = $('<a>').text("Next Week");
                    if (timestamp < weekInProgress) {
                        nextWeekLink.attr('href', '?timestamp=' + (timestamp + 7 * 24 * 60 * 60));
                        $('#provisional').hide();
                    } else {
                        $('#provisional').show();
                    }
                    $('#next').append(nextWeekLink);
                });
            });
        </script>
    </head>
    <body>
        <div id="content">
            <h1><a href="index.html">RAGL Ladder</a></h1>
            <h2>Rankings as of <span id="date"></span><span id="provisional" style="display: none;"> (provisional)</span>:</h2>
            <div id="navigation">
                <span id="previous"></span>
                <span id="next"></span>
            </div>
            <table id="results">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Rating</th>
                        <th>Error</th>
                        <th>Played</th>
                        <th>Won</th>
                    </tr>
                </thead>
                <tbody id="week">

                </tbody>
            </table>
        </div>
    </body>
</html>
